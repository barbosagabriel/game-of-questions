<!DOCTYPE html>
<html>
  <head>
    <title>Game of Questions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Mobile-first realtime trivia client" />
    <link rel="stylesheet" href="css/index.css" />
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="/preloaded-categories.js"></script>
  </head>
  <body>
    <main id="container">
      <section id="join-section">
        <h1 id="title">Quiz Flash</h1>
        <div id="join-form">
          <div class="field">
            <label class="label">Nome:</label>
            <input id="username" type="text" name="username" autocomplete="off" />
          </div>
          <div class="field">
            <label class="label">C√≥digo da Sala:</label>
            <input id="pin" type="number" name="pin" />
          </div>
          <div class="field">
            <button type="button" id="btn-join" class="btn" onclick="joinRoom()">Entrar</button>
          </div>
          <div class="field">
            <button type="button" class="btn" onclick="createRoom()">Criar nova sala</button>
          </div>
        </div>
      </section>
      <section id="lobby" class="hidden">
        <div id="host-pin-top" class="host-pin-top hidden"></div>
        <h2>Aguardando o jogo ser iniciado...</h2>
        <div class="loader"></div>
        <div id="players-list" class="players-list"></div>
        <div id="host-panel" class="host-panel hidden">
          <div id="host-pin" class="pin"></div>
          <div style="margin-top:8px">
            <label class="label">Categoria</label>
            <select id="host-category">
              <option value="">Todas</option>
            </select>
            <label class="label">Dificuldade</label>
            <select id="host-difficulty">
              <option value="">Todas</option>
              <option value="easy">F√°cil</option>
              <option value="medium">M√©dia</option>
              <option value="hard">Dif√≠cil</option>
            </select>
            <label class="label">N√∫mero de perguntas</label>
            <input id="host-amount" type="number" min="1" max="50" value="10" />
            <label class="label">Tempo por pergunta (s)</label>
            <input id="host-time" type="number" min="5" max="120" value="10" />
            <button id="host-start" class="btn" onclick="startGameHost()">Iniciar jogo</button>
          </div>
        </div>
        <div style="margin-top:12px">
          <button class="btn" onclick="leaveRoom()">Sair da sala</button>
        </div>
      </section>

      <section id="question" class="hidden">
        <div id="qmeta" class="qmeta"></div>
        <h2 id="qtext"></h2>
        <div id="answers" class="answers"></div>
        <div id="countdown" class="countdown">
          <div class="timer">
            <div class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>
            <div id="countdown-number" class="countdown-number"></div>
          </div>
        </div>
      </section>

      <section id="final" class="hidden"></section>
    </main>
    <script type="text/javascript">
      var socket = io();
      var isHost = false;
      var currentPin = null;
      var countdownInterval = null;
      var timerRaf = null;

      function clearCountdown() {
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        if (timerRaf) { cancelAnimationFrame(timerRaf); timerRaf = null; }
        var numEl = document.getElementById('countdown-number'); if (numEl) numEl.innerText = '';
        var fill = document.getElementById('timer-fill'); if (fill) fill.style.width = '0%';
      }
      // hard-coded categories list (from categories.json)
      const CATEGORIES = [
        { id: 9, name: 'Conhecimentos gerais' },
        { id: 10, name: 'Entretenimento: Livros' },
        { id: 11, name: 'Entretenimento: Filmes' },
        { id: 12, name: 'Entretenimento: M√∫sicas' },
        { id: 13, name: 'Entretenimento: Musicais e teatro' },
        { id: 14, name: 'Entretenimento: Televis√£o' },
        { id: 15, name: 'Entretenimento: Videogame' },
        { id: 16, name: 'Entretenimento: Jogos de tabuleiro' },
        { id: 17, name: 'Ci√™ncia e natureza' },
        { id: 18, name: 'Ci√™ncia: Computadores' },
        { id: 19, name: 'Ci√™ncia: Matem√°tica' },
        { id: 20, name: 'Mitologia' },
        { id: 21, name: 'Esportes' },
        { id: 22, name: 'Geografia' },
        { id: 23, name: 'Hist√≥ria' },
        { id: 24, name: 'Pol√≠tica' },
        { id: 25, name: 'Arte' },
        { id: 26, name: 'Celebridades' },
        { id: 27, name: 'Animais' },
        { id: 28, name: 'Ve√≠culos' },
        { id: 29, name: 'Entretenimento: Hist√≥rias em quadrinhos' },
        { id: 30, name: 'Ci√™ncia: Dispositivos' },
        { id: 31, name: 'Entretenimento: Anime e Manga' },
        { id: 32, name: 'Entretenimento: Cartoon e anima√ß√µes' }
      ];

      (function populateCategories() {
        const sel = document.getElementById('host-category');
        if (!sel) return;
        sel.innerHTML = '<option value="">Todas</option>';
        CATEGORIES.forEach(c => {
          const o = document.createElement('option'); o.value = c.id; o.innerText = c.name; sel.appendChild(o);
        });
      })();

      function joinRoom() {
        var pinEl = document.getElementById("pin");
        var usernameEl = document.getElementById("username");
        var pin = pinEl ? (pinEl.value || '').toString().trim() : '';
        var username = usernameEl ? (usernameEl.value || '').toString().trim() : '';
        if (!username) {
          alert('Please enter your display name');
          if (usernameEl) usernameEl.focus();
          return;
        }
        if (!pin) {
          alert('Please enter the room code');
          if (pinEl) pinEl.focus();
          return;
        }
        socket.emit("player-join", { pin: pin, username: username });
        // wait for server confirmation (player-joined) before showing lobby
      }

      function createRoom() {
        var username = document.getElementById('username').value || '';
        if (!username.trim()) {
          alert('Please enter your display name to host the game');
          document.getElementById('username').focus();
          return;
        }
        isHost = true;
        socket.emit('room-created');
        document.getElementById('lobby').classList.remove('hidden');
        var jf = document.getElementById('join-section'); if (jf) jf.classList.add('hidden');
        renderPlayers([]);
      }

      function renderQuestion(data) {
        document.getElementById("lobby").classList.add("hidden");
        var jf = document.getElementById('join-section'); if (jf) jf.classList.add('hidden');
        document.getElementById("final").classList.add("hidden");
        document.getElementById("question").classList.remove("hidden");
        document.getElementById("qtext").innerText = data.question;
        document.getElementById("qmeta").innerText = `Question ${data.questionIndex}/${data.total}`;
        var answersEl = document.getElementById("answers");
        answersEl.innerHTML = "";
        data.answers.forEach((a, i) => {
          var btn = document.createElement('button');
          btn.className = 'btn answer';
          btn.innerText = a;
          btn.onclick = () => submitAnswer(a, btn);
          answersEl.appendChild(btn);
        });

        startCountdown(data.timeToAnswer || 10000);
      }

      function submitAnswer(answer, btn) {
        socket.emit('question-answered', { answer: answer });
        // disable answer buttons
        document.querySelectorAll('.answer').forEach(b => b.disabled = true);
        btn.classList.add('selected');
      }

      function startCountdown(ms) {
        clearCountdown();
        var start = performance.now();
        var end = start + ms;
        var numEl = document.getElementById('countdown-number');
        var fill = document.getElementById('timer-fill');

        function tick(now) {
          var remaining = Math.max(0, end - now);
          var secs = Math.ceil(remaining / 1000);
          if (numEl) numEl.innerText = remaining > 0 ? `Time: ${secs}s` : 'Time up';
          if (fill) {
            var pct = Math.min(100, Math.max(0, ((now - start) / ms) * 100));
            fill.style.width = pct + '%';
          }
          if (remaining <= 0) { timerRaf = null; return; }
          timerRaf = requestAnimationFrame(tick);
        }
        timerRaf = requestAnimationFrame(tick);
      }

      function leaveRoom() {
        var pin = (document.getElementById('pin') && document.getElementById('pin').value) || currentPin;
        socket.emit('leave-room', { pin: pin });
        // reset UI to initial state
        var jf = document.getElementById('join-section'); if (jf) jf.classList.remove('hidden');
        var lobby = document.getElementById('lobby'); if (lobby) lobby.classList.add('hidden');
        var question = document.getElementById('question'); if (question) { question.classList.add('hidden'); var ans = document.getElementById('answers'); if (ans) ans.innerHTML = ''; }
        var final = document.getElementById('final'); if (final) { final.classList.add('hidden'); final.innerHTML = ''; }
        var scores = document.getElementById('scores'); if (scores) scores.remove();
        // hide host UI
        var panel = document.getElementById('host-panel'); if (panel) panel.classList.add('hidden');
        var topPin = document.getElementById('host-pin-top'); if (topPin) { topPin.classList.add('hidden'); topPin.innerText = ''; }
        var hostPin = document.getElementById('host-pin'); if (hostPin) hostPin.innerText = '';
        // clear players list
        var playersList = document.getElementById('players-list'); if (playersList) playersList.innerHTML = '';
        // reset flags and values
        isHost = false;
        currentPin = null;
        if (document.getElementById('pin')) document.getElementById('pin').value = '';
        // clear countdown
        clearInterval(countdownInterval);
        var countdownEl = document.getElementById('countdown'); if (countdownEl) countdownEl.innerText = '';
        // remove any answer highlights
        document.querySelectorAll('.answer').forEach(b => { b.classList.remove('correct','wrong','selected'); b.disabled = false; });
      }

      // host controls
      function startGameHost() {
        var amountEl = document.getElementById('host-amount');
        var amount = amountEl ? Number(amountEl.value) : 10;
        var timeEl = document.getElementById('host-time');
        var time = timeEl ? Number(timeEl.value) : 10;
        var catEl = document.getElementById('host-category');
        var diffEl = document.getElementById('host-difficulty');
        var category = catEl ? catEl.value : '';
        var difficulty = diffEl ? diffEl.value : '';
        socket.emit('game-started', { amount: amount, timeToAnswer: time, category: category, difficulty: difficulty });
        document.getElementById('host-start').style.display = 'none';
      }

      function restartSameGameHost() {
        if (!isHost) return;
        document.getElementById('final').classList.add('hidden');
        document.getElementById('lobby').classList.remove('hidden');
        document.getElementById('host-start').style.display = 'block';
      }

      function renderPlayers(players) {
        var container = document.getElementById('players-list');
        if (!container) return;
        if (!players || players.length === 0) {
          container.innerHTML = '<div class="muted">Nenhum jogador conectado</div>';
          return;
        }
        container.innerHTML = '<h3>Jogadores conectados</h3>' + players.map(p => `<div>${p.username}</div>`).join('');
      }

      socket.on('player-joined', data => {
        // data.players contains current players
        renderPlayers(data.players);
        // reveal lobby if not visible
        document.getElementById('lobby').classList.remove('hidden');
        var jf = document.getElementById('join-section'); if (jf) jf.classList.add('hidden');
      });

      socket.on('room-not-found', ({ pin }) => {
        var createNew = confirm('Sala n√£o encontrada. Deseja criar uma nova sala?');
        if (createNew) {
          createRoom();
        } else {
          var pinEl = document.getElementById('pin'); if (pinEl) pinEl.focus();
        }
      });

      socket.on('room-pin', data => {
        currentPin = data.pin;
        if (isHost) {
          var panel = document.getElementById('host-panel');
          if (panel) panel.classList.remove('hidden');
          var topPin = document.getElementById('host-pin-top');
          if (topPin) { topPin.innerText = 'C√≥digo da sala: ' + data.pin; topPin.classList.remove('hidden'); }
          // auto-join host as a player using the entered display name
          var username = document.getElementById('username').value || '';
          if (username.trim()) {
            socket.emit('player-join', { pin: data.pin, username: username });
          }
        }
      });

      socket.on('player-left', data => {
        renderPlayers(data.players);
      });

      socket.on('next-question', data => {
        renderQuestion(data);
      });

      socket.on('time-up', () => {
        // handled by reveal-answer which will also color choices
        document.getElementById('countdown').innerText = "Time's up";
        document.querySelectorAll('.answer').forEach(b => b.disabled = true);
        clearInterval(countdownInterval);
      });

      socket.on('load-error', ({ message }) => {
        // show friendly message and keep leave button visible
        alert(message || 'Failed to load questions.');
        // show lobby so host can try again or leave
        document.getElementById('lobby').classList.remove('hidden');
        var panel = document.getElementById('host-panel'); if (panel) panel.classList.remove('hidden');
      });

      socket.on('reveal-answer', ({ correctAnswer }) => {
        clearInterval(countdownInterval);
        var els = document.querySelectorAll('.answer');
        els.forEach(b => {
          b.disabled = true;
          if (b.innerText === correctAnswer) {
            b.classList.add('correct');
          }
          if (b.classList.contains('selected') && b.innerText !== correctAnswer) {
            b.classList.add('wrong');
          }
        });
      });

      socket.on('partial-results', data => {
        // show brief scoreboard below
        var main = document.getElementById('question');
        var html = '<h3>Ranking parcial</h3>' + data.players.map(p => `<div>${p.username}: ${p.score}</div>`).join('');
        var existing = document.getElementById('scores');
        if (!existing) {
          var div = document.createElement('div'); div.id = 'scores'; div.className = 'scores'; div.innerHTML = html; main.appendChild(div);
        } else { existing.innerHTML = html; }
      });

      socket.on('results', data => {
        document.getElementById('question').classList.add('hidden');
        document.getElementById('final').classList.remove('hidden');
        var el = document.getElementById('final');
        // render ranking with top3 icons
        var html = '<h2>Resultado Final</h2><ol class="ranking">';
        data.players.forEach((p, i) => {
          var icon = '';
          if (i === 0) icon = ' üèÜ';
          else if (i === 1) icon = ' ü•à';
          else if (i === 2) icon = ' ü•â';
          html += `<li class="result">${p.username}: ${p.score}${icon}</li>`;
        });
        html += '</ol>';
        if (isHost) {
          html += '<div style="margin-top:12px"><button class="btn" onclick="restartSameGameHost()">Reiniciar jogo</button><button class="btn" onclick="leaveRoom()">Sair</button></div>';
        } else {
          html += '<div style="margin-top:12px"><button class="btn" onclick="leaveRoom()">Sair</button></div>';
        }
        el.innerHTML = html;
      });

      socket.on('host-disconnected', () => {
        document.getElementById('container').innerHTML = '<h1>O organizador est√° offline. Jogo finalizado</h1>';
      });
    </script>
  </body>
</html>
